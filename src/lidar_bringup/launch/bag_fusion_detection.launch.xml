<launch>
  <!-- ============== -->
  <!-- User arguments -->
  <!-- ============== -->
  <arg name="bag_path" default="/home/a-s/lidar_ws/bags/raw/bag_all_2026-01-15_14-21-44"/>
  <arg name="use_sim_time" default="true"/>

  <arg name="urdf_path" default="$(find-pkg-share lidar_description)/urdf/ship.urdf.xacro"/>

  <!-- Use repo-tracked RViz config by default -->
  <arg name="rviz_config" default="$(find-pkg-share lidar_bringup)/../../../../rviz/bag_compare.rviz"/>

  <arg name="bag_rate" default="1.0"/>
  <arg name="bag_loop" default="false"/>

  <!-- ===================== -->
  <!-- TF: robot_state_publisher -->
  <!-- ===================== -->
  <node pkg="robot_state_publisher" exec="robot_state_publisher" name="robot_state_publisher" output="screen">
    <param name="robot_description" value="$(command 'xacro $(var urdf_path)')"/>
    <param name="use_sim_time" value="$(var use_sim_time)"/>
  </node>

  <!-- ===================== -->
  <!-- Fusion (Python) -->
  <!-- ===================== -->
  <node pkg="lidar_py_pkg" exec="cloud_fusion" name="cloud_fusion" output="screen">
    <param name="input_topics" value="[/front/cloud, /right/cloud, /back/cloud, /left/cloud]"/>
    <param name="target_frame" value="base_link"/>
    <param name="voxel_size" value="0.05"/>
    <param name="max_age_sec" value="0.5"/>
    <param name="publish_topic" value="/nova/cloud_fused"/>
    <param name="publish_rate_hz" value="10.0"/>
    <param name="use_sim_time" value="$(var use_sim_time)"/>
  </node>

  <!-- ===================== -->
  <!-- Algorithm A (C++ PCL) on FUSED -->
  <!-- ===================== -->
  <node pkg="lidar_cpp_pkg" exec="object_detector_pcl" name="detector_cpp_fused" output="screen">
    <param name="input_topic" value="/nova/cloud_fused"/>
    <param name="marker_topic" value="/cpp/fused/detections"/>
    <param name="target_frame" value="base_link"/>

    <param name="tf_timeout_sec" value="0.2"/>

    <param name="voxel_leaf" value="0.05"/>
    <param name="sor_mean_k" value="20"/>
    <param name="sor_stddev" value="1.0"/>

    <param name="plane_dist_thresh" value="0.05"/>
    <param name="plane_max_iter" value="150"/>

    <param name="cluster_tolerance" value="0.35"/>
    <param name="cluster_min_size" value="20"/>
    <param name="cluster_max_size" value="200000"/>

    <param name="min_z" value="-0.2"/>
    <param name="max_z" value="2.0"/>

    <param name="marker_lifetime_sec" value="0.5"/>
  </node>

  <!-- ===================== -->
  <!-- Algorithm A (C++ PCL) per-sensor -->
  <!-- ===================== -->
  <node pkg="lidar_cpp_pkg" exec="object_detector_pcl" name="detector_cpp_front" output="screen">
    <param name="input_topic" value="/front/cloud"/>
    <param name="marker_topic" value="/cpp/front/detections"/>
    <param name="target_frame" value="base_link"/>
    <param name="tf_timeout_sec" value="0.2"/>
    <param name="marker_lifetime_sec" value="0.5"/>
  </node>

  <node pkg="lidar_cpp_pkg" exec="object_detector_pcl" name="detector_cpp_right" output="screen">
    <param name="input_topic" value="/right/cloud"/>
    <param name="marker_topic" value="/cpp/right/detections"/>
    <param name="target_frame" value="base_link"/>
    <param name="tf_timeout_sec" value="0.2"/>
    <param name="marker_lifetime_sec" value="0.5"/>
  </node>

  <node pkg="lidar_cpp_pkg" exec="object_detector_pcl" name="detector_cpp_back" output="screen">
    <param name="input_topic" value="/back/cloud"/>
    <param name="marker_topic" value="/cpp/back/detections"/>
    <param name="target_frame" value="base_link"/>
    <param name="tf_timeout_sec" value="0.2"/>
    <param name="marker_lifetime_sec" value="0.5"/>
  </node>

  <node pkg="lidar_cpp_pkg" exec="object_detector_pcl" name="detector_cpp_left" output="screen">
    <param name="input_topic" value="/left/cloud"/>
    <param name="marker_topic" value="/cpp/left/detections"/>
    <param name="target_frame" value="base_link"/>
    <param name="tf_timeout_sec" value="0.2"/>
    <param name="marker_lifetime_sec" value="0.5"/>
  </node>

  <!-- ===================== -->
  <!-- Algorithm B (Python DBSCAN) on FUSED -->
  <!-- ===================== -->
  <node pkg="lidar_py_pkg" exec="cloud_detector" name="detector_py_fused" output="screen">
    <param name="input_topic" value="/nova/cloud_fused"/>
    <param name="marker_topic" value="/py/fused/detections"/>
    <param name="target_frame" value="base_link"/>
    <param name="min_z" value="-0.2"/>
    <param name="max_z" value="2.0"/>
    <param name="voxel_size" value="0.05"/>
    <param name="cluster_eps" value="0.40"/>
    <param name="cluster_min_pts" value="20"/>
    <param name="use_sim_time" value="$(var use_sim_time)"/>
  </node>

  <!-- ===================== -->
  <!-- Bag playback -->
  <!-- ===================== -->
  <!-- Default: no loop -->
 
  <executable cmd="ros2 bag play $(var bag_path) --clock --rate $(var bag_rate) --loop" output="screen"/>
 

  <!-- ===================== -->
  <!-- RViz (loads your saved config) -->
  <!-- ===================== -->
  <node pkg="rviz2" exec="rviz2" name="rviz2" output="screen" args="-d $(var rviz_config)">
    <param name="use_sim_time" value="$(var use_sim_time)"/>
  </node>
</launch>
