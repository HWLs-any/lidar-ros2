<launch>
  <!-- ================= -->
  <!-- User arguments    -->
  <!-- ================= -->
  <arg name="use_sim_time" default="false"/>

  <arg name="config_dir" default="$(find-pkg-share lidar_bringup)/config"/>
  <arg name="urdf_path" default="$(find-pkg-share lidar_description)/urdf/ship.urdf.xacro"/>

  <!-- ========================= -->
  <!-- Launch live sensors       -->
  <!-- ========================= -->
  <!-- SICK MRS 6xxx drivers: one per sensor --> 
  <!-- Note: set scanner_type to your exact model if needed, e.g., sick_mrs_6124 --> 
  <node pkg="sick_scan_xd" exec="sick_generic_caller" name="front_driver" output="screen"> 
    <param name="scanner_type" value="sick_mrs_6xxx"/> 
    <param name="hostname" value="$(var front_ip)"/> 
    <param name="frame_id" value="f_lidar_link"/> 
    <param name="cloud_topic" value="/front/cloud"/> 
    <param name="laserscan_topic" value="/front/scan"/> 
    <param name="imu_topic" value="/front/imu"/> 
    <param name="tf_publish_rate" value="0.0"/> 
    <param name="use_binary_protocol" value="$(var use_binary_protocol)"/> 
  </node> 
  <node pkg="sick_scan_xd" exec="sick_generic_caller" name="right_driver" output="screen"> 
    <param name="scanner_type" value="sick_mrs_6xxx"/> 
    <param name="hostname" value="$(var right_ip)"/> 
    <param name="frame_id" value="r_lidar_link"/> 
    <param name="cloud_topic" value="/right/cloud"/> 
    <param name="laserscan_topic" value="/right/scan"/> 
    <param name="imu_topic" value="/right/imu"/> 
    <param name="tf_publish_rate" value="0.0"/> 
    <param name="use_binary_protocol" value="$(var use_binary_protocol)"/> 
  </node> 
  <node pkg="sick_scan_xd" exec="sick_generic_caller" name="back_driver" output="screen"> 
    <param name="scanner_type" value="sick_mrs_6xxx"/> 
    <param name="hostname" value="$(var back_ip)"/> 
    <param name="frame_id" value="b_lidar_link"/> 
    <param name="cloud_topic" value="/back/cloud"/> 
    <param name="laserscan_topic" value="/back/scan"/> 
    <param name="imu_topic" value="/back/imu"/> 
    <param name="tf_publish_rate" value="0.0"/> 
    <param name="use_binary_protocol" value="$(var use_binary_protocol)"/> 
  </node> 
  <node pkg="sick_scan_xd" exec="sick_generic_caller" name="left_driver" output="screen"> 
    <param name="scanner_type" value="sick_mrs_6xxx"/> 
    <param name="hostname" value="$(var left_ip)"/> 
    <param name="frame_id" value="l_lidar_link"/> 
    <param name="cloud_topic" value="/left/cloud"/> 
    <param name="laserscan_topic" value="/left/scan"/> 
    <param name="imu_topic" value="/left/imu"/> 
    <param name="tf_publish_rate" value="0.0"/> 
    <param name="use_binary_protocol" value="$(var use_binary_protocol)"/> 
  </node>

  <!-- ========================= -->
  <!-- Robot TF via URDF (xacro) -->
  <!-- ========================= -->
  <node pkg="robot_state_publisher" exec="robot_state_publisher" name="robot_state_publisher" output="screen">
    <param name="robot_description" value="$(command 'xacro $(var urdf_path)')"/>
    <param name="use_sim_time" value="$(var use_sim_time)"/>
  </node>

  <!-- ===================== -->
  <!-- Fusion (Python)       -->
  <!-- ===================== -->
  <node pkg="lidar_py_pkg" exec="cloud_fusion" name="cloud_fusion" output="screen">
    <param from="$(var config_dir)/fusion.yaml"/>
    <param name="use_sim_time" value="$(var use_sim_time)"/>
  </node>

  <!-- ================================== -->
  <!-- Algorithm A: C++ PCL detector       -->
  <!-- ================================== -->

  <!-- FUSED -->
  <node pkg="lidar_cpp_pkg" exec="object_detector_pcl" name="detector_cpp_fused" output="screen">
    <param from="$(var config_dir)/detector_cpp.yaml"/>
    <param name="use_sim_time" value="$(var use_sim_time)"/>

    <param name="input_topic" value="/nova/cloud_fused"/>
    <param name="marker_topic" value="/detections/pcl/fused"/>
    <param name="metrics_prefix" value="/metrics/pcl/fused"/>

    <!-- Fused-specific cropping -->
    <param name="min_z" value="-0.2"/>
    <param name="max_z" value="2.0"/>
  </node>

  <!-- FRONT -->
  <node pkg="lidar_cpp_pkg" exec="object_detector_pcl" name="detector_cpp_front">
    <param from="$(var config_dir)/detector_cpp.yaml"/>
    <param name="use_sim_time" value="$(var use_sim_time)"/>

    <param name="input_topic" value="/front/cloud"/>
    <param name="marker_topic" value="/detections/pcl/front"/>
    <param name="metrics_prefix" value="/metrics/pcl/front"/>
  </node>

  <!-- RIGHT -->
  <node pkg="lidar_cpp_pkg" exec="object_detector_pcl" name="detector_cpp_right">
    <param from="$(var config_dir)/detector_cpp.yaml"/>
    <param name="use_sim_time" value="$(var use_sim_time)"/>

    <param name="input_topic" value="/right/cloud"/>
    <param name="marker_topic" value="/detections/pcl/right"/>
    <param name="metrics_prefix" value="/metrics/pcl/right"/>
  </node>

  <!-- BACK -->
  <node pkg="lidar_cpp_pkg" exec="object_detector_pcl" name="detector_cpp_back">
    <param from="$(var config_dir)/detector_cpp.yaml"/>
    <param name="use_sim_time" value="$(var use_sim_time)"/>

    <param name="input_topic" value="/back/cloud"/>
    <param name="marker_topic" value="/detections/pcl/back"/>
    <param name="metrics_prefix" value="/metrics/pcl/back"/>
  </node>

  <!-- LEFT -->
  <node pkg="lidar_cpp_pkg" exec="object_detector_pcl" name="detector_cpp_left">
    <param from="$(var config_dir)/detector_cpp.yaml"/>
    <param name="use_sim_time" value="$(var use_sim_time)"/>

    <param name="input_topic" value="/left/cloud"/>
    <param name="marker_topic" value="/detections/pcl/left"/>
    <param name="metrics_prefix" value="/metrics/pcl/left"/>
  </node>

  <!-- ================================= -->
  <!-- Algorithm B: Python DBSCAN (FUSED) -->
  <!-- ================================= -->
  <node pkg="lidar_py_pkg" exec="cloud_detector" name="detector_py_fused" output="screen">
    <param from="$(var config_dir)/dbscan_fused.yaml"/>
    <param name="use_sim_time" value="$(var use_sim_time)"/>
  </node>

  <!-- ===================== -->
  <!-- Metrics CSV logger    -->
  <!-- ===================== -->
  <node pkg="lidar_py_pkg" exec="metrics_csv_logger" name="metrics_csv_logger" output="screen">
    <param name="use_sim_time" value="$(var use_sim_time)"/>
    <param name="output_dir" value="$(env HOME)/lidar_ws/results"/>
  </node>

</launch>
