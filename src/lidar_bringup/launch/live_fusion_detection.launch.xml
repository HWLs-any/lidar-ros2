<launch>
  <!-- ================= -->
  <!-- User arguments    -->
  <!-- ================= -->
  <arg name="use_sim_time" default="false"/>
  <arg name="target_frame" default="base_link"/>

  <arg name="config_dir" default="$(find-pkg-share lidar_bringup)/config"/>
  <arg name="urdf_path" default="$(find-pkg-share lidar_description)/urdf/ship.urdf.xacro"/>

   <!-- input topics -->
  <arg name="front_topic" default="/front/cloud"/>
  <arg name="right_topic" default="/right/cloud"/>
  <arg name="back_topic" default="/back/cloud"/>
  <arg name="left_topic" default="/left/cloud"/>
  <arg name="fused_topic" default="/nova/cloud_fused"/>

  <!-- DBSCAN params (good outdoor-ish defaults) -->
  <arg name="min_range" default="0.5"/>
  <arg name="max_range" default="80.0"/>
  <arg name="min_z" default="-0.2"/>
  <arg name="max_z" default="2.0"/>

  <arg name="voxel_size" default="0.07"/>
  <arg name="cluster_eps" default="0.45"/>
  <arg name="cluster_min_pts" default="25"/>

  <!-- BAG PATH and rviz -->
  <arg name="bag_path" default="/home/a-s/lidar_ws/bags/outdoor_2026-02-04/S1_empty_14-06-15"/>
  <arg name="bag_rate" default="0.5"/>
  <arg name="play_bag" default="true"/>

  <arg name="rviz_config" default="/home/a-s/lidar_ws/src/lidar_bringup/rviz/live_fusion.rviz"/>
  <arg name="start_rviz" default="true"/>


  <!-- ========================= -->
  <!-- Launch live sensors       -->
  <!-- ========================= -->
  <!-- SICK MRS 6xxx drivers: one per sensor --> 
  <!-- Note: set scanner_type to your exact model if needed, e.g., sick_mrs_6124 --> 
  <node pkg="sick_scan_xd" exec="sick_generic_caller" name="front_driver" output="screen"> 
    <param name="scanner_type" value="sick_mrs_6xxx"/> 
    <param name="hostname" value="$(var front_ip)"/> 
    <param name="frame_id" value="f_lidar_link"/> 
    <param name="cloud_topic" value="/front/cloud"/> 
    <param name="laserscan_topic" value="/front/scan"/> 
    <param name="imu_topic" value="/front/imu"/> 
    <param name="tf_publish_rate" value="0.0"/> 
    <param name="use_binary_protocol" value="$(var use_binary_protocol)"/> 
  </node> 
  <node pkg="sick_scan_xd" exec="sick_generic_caller" name="right_driver" output="screen"> 
    <param name="scanner_type" value="sick_mrs_6xxx"/> 
    <param name="hostname" value="$(var right_ip)"/> 
    <param name="frame_id" value="r_lidar_link"/> 
    <param name="cloud_topic" value="/right/cloud"/> 
    <param name="laserscan_topic" value="/right/scan"/> 
    <param name="imu_topic" value="/right/imu"/> 
    <param name="tf_publish_rate" value="0.0"/> 
    <param name="use_binary_protocol" value="$(var use_binary_protocol)"/> 
  </node> 
  <node pkg="sick_scan_xd" exec="sick_generic_caller" name="back_driver" output="screen"> 
    <param name="scanner_type" value="sick_mrs_6xxx"/> 
    <param name="hostname" value="$(var back_ip)"/> 
    <param name="frame_id" value="b_lidar_link"/> 
    <param name="cloud_topic" value="/back/cloud"/> 
    <param name="laserscan_topic" value="/back/scan"/> 
    <param name="imu_topic" value="/back/imu"/> 
    <param name="tf_publish_rate" value="0.0"/> 
    <param name="use_binary_protocol" value="$(var use_binary_protocol)"/> 
  </node> 
  <node pkg="sick_scan_xd" exec="sick_generic_caller" name="left_driver" output="screen"> 
    <param name="scanner_type" value="sick_mrs_6xxx"/> 
    <param name="hostname" value="$(var left_ip)"/> 
    <param name="frame_id" value="l_lidar_link"/> 
    <param name="cloud_topic" value="/left/cloud"/> 
    <param name="laserscan_topic" value="/left/scan"/> 
    <param name="imu_topic" value="/left/imu"/> 
    <param name="tf_publish_rate" value="0.0"/> 
    <param name="use_binary_protocol" value="$(var use_binary_protocol)"/> 
  </node>

  <!-- ========================= -->
  <!-- Robot TF via URDF (xacro) -->
  <!-- ========================= -->
  <node pkg="robot_state_publisher" exec="robot_state_publisher" name="robot_state_publisher" output="screen">
    <param name="robot_description" value="$(command 'xacro $(var urdf_path)')"/>
    <param name="use_sim_time" value="$(var use_sim_time)"/>
  </node>

  <!-- ===================== -->
  <!-- Fusion (Python)       -->
  <!-- ===================== -->
  <node pkg="lidar_py_pkg" exec="cloud_fusion" name="cloud_fusion" output="screen">
    <param from="$(var config_dir)/fusion.yaml"/>
    <param name="use_sim_time" value="$(var use_sim_time)"/>
  </node>

  <!-- Fused DBSCAN -->
  <node pkg="lidar_py_pkg" exec="cloud_detector" name="dbscan_fused" output="screen">
    <param name="use_sim_time" value="$(var use_sim_time)"/>
    <param name="input_topic" value="$(var fused_topic)"/>
    <param name="marker_topic" value="/detections/dbscan/fused"/>
    <param name="target_frame" value="$(var target_frame)"/>

    <param name="min_range" value="$(var min_range)"/>
    <param name="max_range" value="$(var max_range)"/>
    <param name="min_z" value="$(var min_z)"/>
    <param name="max_z" value="$(var max_z)"/>

    <param name="voxel_size" value="$(var voxel_size)"/>
    <param name="cluster_eps" value="$(var cluster_eps)"/>
    <param name="cluster_min_pts" value="$(var cluster_min_pts)"/>
  </node>

  <!-- PER-SENSOR DBSCAN -->
  <node pkg="lidar_py_pkg" exec="cloud_detector" name="dbscan_front" output="screen">
    <param name="use_sim_time" value="$(var use_sim_time)"/>
    <param name="input_topic" value="$(var front_topic)"/>
    <param name="marker_topic" value="/detections/dbscan/front"/>
    <param name="target_frame" value="$(var target_frame)"/>
    <param name="min_range" value="$(var min_range)"/>
    <param name="max_range" value="$(var max_range)"/>
    <param name="min_z" value="$(var min_z)"/>
    <param name="max_z" value="$(var max_z)"/>
    <param name="voxel_size" value="$(var voxel_size)"/>
    <param name="cluster_eps" value="$(var cluster_eps)"/>
    <param name="cluster_min_pts" value="$(var cluster_min_pts)"/>
  </node>

  <node pkg="lidar_py_pkg" exec="cloud_detector" name="dbscan_right" output="screen">
    <param name="use_sim_time" value="$(var use_sim_time)"/>
    <param name="input_topic" value="$(var right_topic)"/>
    <param name="marker_topic" value="/detections/dbscan/right"/>
    <param name="target_frame" value="$(var target_frame)"/>
    <param name="min_range" value="$(var min_range)"/>
    <param name="max_range" value="$(var max_range)"/>
    <param name="min_z" value="$(var min_z)"/>
    <param name="max_z" value="$(var max_z)"/>
    <param name="voxel_size" value="$(var voxel_size)"/>
    <param name="cluster_eps" value="$(var cluster_eps)"/>
    <param name="cluster_min_pts" value="$(var cluster_min_pts)"/>
  </node>

  <node pkg="lidar_py_pkg" exec="cloud_detector" name="dbscan_back" output="screen">
    <param name="use_sim_time" value="$(var use_sim_time)"/>
    <param name="input_topic" value="$(var back_topic)"/>
    <param name="marker_topic" value="/detections/dbscan/back"/>
    <param name="target_frame" value="$(var target_frame)"/>
    <param name="min_range" value="$(var min_range)"/>
    <param name="max_range" value="$(var max_range)"/>
    <param name="min_z" value="$(var min_z)"/>
    <param name="max_z" value="$(var max_z)"/>
    <param name="voxel_size" value="$(var voxel_size)"/>
    <param name="cluster_eps" value="$(var cluster_eps)"/>
    <param name="cluster_min_pts" value="$(var cluster_min_pts)"/>
  </node>

  <node pkg="lidar_py_pkg" exec="cloud_detector" name="dbscan_left" output="screen">
    <param name="use_sim_time" value="$(var use_sim_time)"/>
    <param name="input_topic" value="$(var left_topic)"/>
    <param name="marker_topic" value="/detections/dbscan/left"/>
    <param name="target_frame" value="$(var target_frame)"/>
    <param name="min_range" value="$(var min_range)"/>
    <param name="max_range" value="$(var max_range)"/>
    <param name="min_z" value="$(var min_z)"/>
    <param name="max_z" value="$(var max_z)"/>
    <param name="voxel_size" value="$(var voxel_size)"/>
    <param name="cluster_eps" value="$(var cluster_eps)"/>
    <param name="cluster_min_pts" value="$(var cluster_min_pts)"/>
  </node>

  <!-- ================================== -->
  <!-- Algorithm A: C++ PCL detector       -->
  <!-- ================================== -->

  <!-- FUSED -->
  <node pkg="lidar_cpp_pkg" exec="object_detector_pcl" name="detector_cpp_fused" output="screen">
    <param from="$(var config_dir)/detector_cpp.yaml"/>
    <param name="use_sim_time" value="$(var use_sim_time)"/>

    <param name="input_topic" value="/nova/cloud_fused"/>
    <param name="marker_topic" value="/detections/pcl/fused"/>
    <param name="metrics_prefix" value="/metrics/pcl/fused"/>

    <!-- Fused-specific cropping -->
    <param name="min_z" value="-0.2"/>
    <param name="max_z" value="2.0"/>
  </node>

  <!-- FRONT -->
  <node pkg="lidar_cpp_pkg" exec="object_detector_pcl" name="detector_cpp_front">
    <param from="$(var config_dir)/detector_cpp.yaml"/>
    <param name="use_sim_time" value="$(var use_sim_time)"/>

    <param name="input_topic" value="/front/cloud"/>
    <param name="marker_topic" value="/detections/pcl/front"/>
    <param name="metrics_prefix" value="/metrics/pcl/front"/>
  </node>

  <!-- RIGHT -->
  <node pkg="lidar_cpp_pkg" exec="object_detector_pcl" name="detector_cpp_right">
    <param from="$(var config_dir)/detector_cpp.yaml"/>
    <param name="use_sim_time" value="$(var use_sim_time)"/>

    <param name="input_topic" value="/right/cloud"/>
    <param name="marker_topic" value="/detections/pcl/right"/>
    <param name="metrics_prefix" value="/metrics/pcl/right"/>
  </node>

  <!-- BACK -->
  <node pkg="lidar_cpp_pkg" exec="object_detector_pcl" name="detector_cpp_back">
    <param from="$(var config_dir)/detector_cpp.yaml"/>
    <param name="use_sim_time" value="$(var use_sim_time)"/>

    <param name="input_topic" value="/back/cloud"/>
    <param name="marker_topic" value="/detections/pcl/back"/>
    <param name="metrics_prefix" value="/metrics/pcl/back"/>
  </node>

  <!-- LEFT -->
  <node pkg="lidar_cpp_pkg" exec="object_detector_pcl" name="detector_cpp_left">
    <param from="$(var config_dir)/detector_cpp.yaml"/>
    <param name="use_sim_time" value="$(var use_sim_time)"/>

    <param name="input_topic" value="/left/cloud"/>
    <param name="marker_topic" value="/detections/pcl/left"/>
    <param name="metrics_prefix" value="/metrics/pcl/left"/>
  </node>

  <!-- ================================= -->
  <!-- Algorithm B: Python DBSCAN (FUSED) -->
  <!-- ================================= -->
  <node pkg="lidar_py_pkg" exec="cloud_detector" name="detector_py_fused" output="screen">
    <param from="$(var config_dir)/dbscan_fused.yaml"/>
    <param name="use_sim_time" value="$(var use_sim_time)"/>
  </node>

  <!-- ===================== -->
  <!-- Metrics CSV logger    -->
  <!-- ===================== -->
  <node pkg="lidar_py_pkg" exec="metrics_csv_logger" name="metrics_csv_logger" output="screen">
    <param name="use_sim_time" value="$(var use_sim_time)"/>
    <param name="output_dir" value="$(env HOME)/lidar_ws/results"/>
  </node>

  <!-- ===================== -->
  <!-- Rviz and BAG    -->
  <!-- ===================== -->
  <group if="$(var start_rviz)">
    <node pkg="rviz2" exec="rviz2" name="rviz2" output="screen"
          args="-d $(var rviz_config)">
      <param name="use_sim_time" value="true"/>
    </node>
  </group>
  <group if="$(var play_bag)">
  <executable
    cmd="ros2 bag play $(var bag_path) --clock --loop --rate $(var bag_rate)"
    output="screen"/>
</group>

</launch>
