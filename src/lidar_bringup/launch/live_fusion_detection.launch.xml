<launch>
  <!-- ================= -->
  <!-- User arguments    -->
  <!-- ================= -->
  <arg name="bag_path" default="/home/a-s/lidar_ws/bags/raw/bag_all_2026-01-15_14-21-44"/>
  <arg name="bag_rate" default="1.0"/>
  <arg name="play_bag" default="true"/>
  <arg name="use_sim_time" default="true"/>

  <arg name="config_dir" default="$(find-pkg-share lidar_bringup)/config"/>
  <arg name="urdf_path" default="$(find-pkg-share lidar_description)/urdf/ship.urdf.xacro"/>
  <arg name="rviz_config" default="$(find-pkg-share lidar_bringup)/rviz/bag_compare.rviz"/>

  <!-- ========================= -->
  <!-- Robot TF via URDF (xacro) -->
  <!-- ========================= -->
  <node pkg="robot_state_publisher" exec="robot_state_publisher" name="robot_state_publisher" output="screen">
    <param name="robot_description" value="$(command 'xacro $(var urdf_path)')"/>
    <param name="use_sim_time" value="$(var use_sim_time)"/>
  </node>

  <!-- ===================== -->
  <!-- Fusion (Python)       -->
  <!-- ===================== -->
  <node pkg="lidar_py_pkg" exec="cloud_fusion" name="cloud_fusion" output="screen">
    <param from="$(var config_dir)/fusion.yaml"/>
    <param name="use_sim_time" value="$(var use_sim_time)"/>
  </node>

  <!-- ================================== -->
  <!-- Algorithm A: C++ PCL detector       -->
  <!-- Base params from YAML, per-instance -->
  <!-- ================================== -->

  <!-- FUSED -->
  <node pkg="lidar_cpp_pkg" exec="object_detector_pcl" name="detector_cpp_fused" output="screen">
    <param from="$(var config_dir)/detector_cpp.yaml"/>
    <param name="use_sim_time" value="$(var use_sim_time)"/>

    <param name="input_topic" value="/nova/cloud_fused"/>
    <param name="marker_topic" value="/detections/pcl/fused"/>
    <param name="metrics_prefix" value="/metrics/pcl/fused"/>

    <!-- Fused-specific cropping (keeps your previous behavior) -->
    <param name="min_z" value="-0.2"/>
    <param name="max_z" value="2.0"/>
  </node>

  <!-- FRONT -->
  <node pkg="lidar_cpp_pkg" exec="object_detector_pcl" name="detector_cpp_front" output="screen">
    <param from="$(var config_dir)/detector_cpp.yaml"/>
    <param name="use_sim_time" value="$(var use_sim_time)"/>

    <param name="input_topic" value="/front/cloud"/>
    <param name="marker_topic" value="/detections/pcl/front"/>
    <param name="metrics_prefix" value="/metrics/pcl/front"/>
  </node>

  <!-- RIGHT -->
  <node pkg="lidar_cpp_pkg" exec="object_detector_pcl" name="detector_cpp_right" output="screen">
    <param from="$(var config_dir)/detector_cpp.yaml"/>
    <param name="use_sim_time" value="$(var use_sim_time)"/>

    <param name="input_topic" value="/right/cloud"/>
    <param name="marker_topic" value="/detections/pcl/right"/>
    <param name="metrics_prefix" value="/metrics/pcl/right"/>
  </node>

  <!-- BACK -->
  <node pkg="lidar_cpp_pkg" exec="object_detector_pcl" name="detector_cpp_back" output="screen">
    <param from="$(var config_dir)/detector_cpp.yaml"/>
    <param name="use_sim_time" value="$(var use_sim_time)"/>

    <param name="input_topic" value="/back/cloud"/>
    <param name="marker_topic" value="/detections/pcl/back"/>
    <param name="metrics_prefix" value="/metrics/pcl/back"/>
  </node>

  <!-- LEFT -->
  <node pkg="lidar_cpp_pkg" exec="object_detector_pcl" name="detector_cpp_left" output="screen">
    <param from="$(var config_dir)/detector_cpp.yaml"/>
    <param name="use_sim_time" value="$(var use_sim_time)"/>

    <param name="input_topic" value="/left/cloud"/>
    <param name="marker_topic" value="/detections/pcl/left"/>
    <param name="metrics_prefix" value="/metrics/pcl/left"/>
  </node>

  <!-- ================================= -->
  <!-- Algorithm B: Python DBSCAN (FUSED) -->
  <!-- ================================= -->
  <node pkg="lidar_py_pkg" exec="cloud_detector" name="detector_py_fused" output="screen">
    <param from="$(var config_dir)/dbscan_fused.yaml"/>
    <param name="use_sim_time" value="$(var use_sim_time)"/>
  </node>

  <!-- ===================== -->
  <!-- Bag playback          -->
  <!-- ===================== -->
  <group if="$(var play_bag)">
    <executable
      cmd="ros2 bag play $(var bag_path) --clock --rate $(var bag_rate) --loop"
      output="screen"/>
  </group>

  <!-- ===================== -->
  <!-- Metrics CSV logger    -->
  <!-- ===================== -->
  <node pkg="lidar_py_pkg" exec="metrics_csv_logger" name="metrics_csv_logger" output="screen">
    <param name="use_sim_time" value="$(var use_sim_time)"/>
    <param name="output_dir" value="$(env HOME)/lidar_ws/results"/>
    <!-- If you omit 'topics', it auto-subscribes to ALL /metrics/* topics -->
  </node>

  <!-- ===================== -->
  <!-- RViz                  -->
  <!-- ===================== -->
  <node pkg="rviz2" exec="rviz2" name="rviz2" output="screen" args="-d $(var rviz_config)">
    <param name="use_sim_time" value="$(var use_sim_time)"/>
  </node>
</launch>
